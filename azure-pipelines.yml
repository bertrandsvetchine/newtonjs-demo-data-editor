# Build numbering format
name: $(BuildID)

trigger:
  - master
  - feat/*

pool:
  vmImage: "ubuntu-latest"

# ---------
# Schedule
# ---------

schedules:
  - cron: "0 0 * * Mon"
    displayName: Weekly midnight build
    always: true
    branches:
      include:
        - master
        - releases/*

# ------------
# Shared Tasks
# ------------

resources:
  repositories:
    - repository: templates
      type: github
      name: julie-ng/newtonjs-azure-templates
      endpoint: julie-ng # service connection

# ---------
# Variables
# ---------

variables:
  # all variables prefixed `newton-` come from library
  - group: newton-common-vars

  # this pipeline:
  - name: image-namespace
    value: demo

  - name: image-name
    value: data-editor

  - name: docker-image
    value: $(newton-registry)/$(newton-demo-namespace)/$(image-name)

  - name: snapshot-tag
    value: $(docker-image):$(Build.BuildId)

  - name: dev-tag
    value: $(docker-image):dev

# ------
# Stages
# ------

stages:

  # Tests
  # -----

  - stage: Tests
    displayName: "Test (Node.js)"
    jobs:
      - job: Audit
        steps:
          - script: npm audit
            displayName: Audit Dependencies
            continueOnError: true

      - job: Linter
        steps:
          - script: npm ci && npm run lint
            displayName: Lint Code

  # Docker: Build and Push
  # ----------------------

  - stage: BuildAndDeploy
    displayName: "Build and Deploy"
    jobs:
      - job: build_and_deploy
        displayName: Build Docker and Push
        steps:
          - template: azure-devops/docker-build-push.yaml@templates
            parameters:
              dev-tag: $(dev-tag)
              snapshot-tag: $(snapshot-tag)

          - task: AzureWebAppContainer@1
            displayName: "App Service: deploy container"
            condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/master')) # (master branch and succesful builds only)
            inputs:
              appName: $(pipeline-app-name) # var set in pipeline
              azureSubscription: $(newton-service-connection)
              imageName: $(snapshot-tag)-$(build-sha)
